<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶åŠŸèƒ½æµ‹è¯• - Local-trans</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-methods {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .method-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
        }
        .method-success {
            background: #d4edda;
            color: #155724;
        }
        .method-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é‚®ä»¶åŠŸèƒ½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•Local-transç½‘ç«™çš„é‚®ä»¶å‘é€åŠŸèƒ½</p>
        
        <form id="testForm">
            <div class="form-group">
                <label for="name">å§“å:</label>
                <input type="text" id="name" name="name" value="æµ‹è¯•ç”¨æˆ·" required>
            </div>
            
            <div class="form-group">
                <label for="email">é‚®ç®±:</label>
                <input type="email" id="email" name="email" value="test@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="phone">ç”µè¯:</label>
                <input type="tel" id="phone" name="phone" value="13800138000">
            </div>
            
            <div class="form-group">
                <label for="company">å…¬å¸:</label>
                <input type="text" id="company" name="company" value="æµ‹è¯•å…¬å¸">
            </div>
            
            <div class="form-group">
                <label for="message">ç¿»è¯‘éœ€æ±‚:</label>
                <textarea id="message" name="message" rows="4" required>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é‚®ä»¶ï¼Œç”¨äºéªŒè¯é‚®ä»¶å‘é€åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚åŒ…å«ä¸­è‹±æ–‡ç¿»è¯‘éœ€æ±‚ï¼Œé¢„è®¡1000å­—ï¼Œéœ€è¦åœ¨3å¤©å†…å®Œæˆã€‚</textarea>
            </div>
            
            <button type="submit" id="submitBtn">å‘é€æµ‹è¯•é‚®ä»¶</button>
        </form>
        
        <div id="status" class="status"></div>
        
        <div class="test-methods">
            <h3>æµ‹è¯•ç»“æœ:</h3>
            <div id="methodResults"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="js/email-handler.js"></script>
    
    <script>
        // åˆå§‹åŒ–
        let supabaseClient = null;
        let emailHandler = null;
        
        // åˆå§‹åŒ–Supabase
        function initSupabase() {
            try {
                const supabaseUrl = 'https://qxyqydsiavnjmdvnfgcn.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4eXF5ZHNpYXZuam1kdm5mZ2NuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMDUyNjksImV4cCI6MjA2OTU4MTI2OX0.bDigwFOPoiXCHGLfTpZ7VXNMAlHEpGCE5iHB8FPI4ZY';
                
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('âœ… Supabaseåˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆå§‹åŒ–é‚®ä»¶å¤„ç†å™¨
        async function initEmailHandler() {
            if (window.EmailHandler) {
                emailHandler = new window.EmailHandler();
                await emailHandler.initialize(supabaseClient);
                console.log('âœ… é‚®ä»¶å¤„ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } else {
                console.error('âŒ é‚®ä»¶å¤„ç†å™¨ç±»æœªæ‰¾åˆ°');
                return false;
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        // æ·»åŠ æ–¹æ³•æµ‹è¯•ç»“æœ
        function addMethodResult(method, success, message) {
            const resultsDiv = document.getElementById('methodResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `method-result ${success ? 'method-success' : 'method-error'}`;
            resultDiv.textContent = `${method}: ${success ? 'âœ…' : 'âŒ'} ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        // æµ‹è¯•å„ç§é‚®ä»¶å‘é€æ–¹æ³•
        async function testEmailMethods(formData) {
            const resultsDiv = document.getElementById('methodResults');
            resultsDiv.innerHTML = '<h4>æ­£åœ¨æµ‹è¯•å„ç§é‚®ä»¶å‘é€æ–¹æ³•...</h4>';
            
            // æµ‹è¯•1: Supabase Edge Function
            try {
                const result = await emailHandler.sendViaSupabase(formData, 'contact');
                addMethodResult('Supabase Edge Function', true, 'å‘é€æˆåŠŸ');
            } catch (error) {
                addMethodResult('Supabase Edge Function', false, error.message);
            }
            
            // æµ‹è¯•2: EmailJS (å¦‚æœé…ç½®äº†)
            try {
                const result = await emailHandler.sendViaEmailJS(formData, 'contact');
                addMethodResult('EmailJS', true, 'å‘é€æˆåŠŸ');
            } catch (error) {
                addMethodResult('EmailJS', false, error.message);
            }
            
            // æµ‹è¯•3: Formspree (å¦‚æœé…ç½®äº†)
            try {
                const result = await emailHandler.sendViaFormspree(formData, 'contact');
                addMethodResult('Formspree', true, 'å‘é€æˆåŠŸ');
            } catch (error) {
                addMethodResult('Formspree', false, error.message);
            }
            
            // æµ‹è¯•4: æ§åˆ¶å°æ—¥å¿—
            try {
                const result = await emailHandler.logEmailContent(formData, 'contact');
                addMethodResult('æ§åˆ¶å°æ—¥å¿—', true, 'å†…å®¹å·²è®°å½•åˆ°æ§åˆ¶å°');
            } catch (error) {
                addMethodResult('æ§åˆ¶å°æ—¥å¿—', false, error.message);
            }
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'å‘é€ä¸­...';
            
            // è·å–è¡¨å•æ•°æ®
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('phone').value,
                company: document.getElementById('company').value,
                message: document.getElementById('message').value
            };
            
            try {
                showStatus('info', 'æ­£åœ¨æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½...');
                
                if (emailHandler) {
                    // ä½¿ç”¨é‚®ä»¶å¤„ç†å™¨å‘é€
                    const result = await emailHandler.sendNotification(formData, 'contact');
                    showStatus('success', `é‚®ä»¶å‘é€æˆåŠŸ! ä½¿ç”¨æ–¹æ³•: ${result.method}`);
                    
                    // æµ‹è¯•æ‰€æœ‰æ–¹æ³•
                    await testEmailMethods(formData);
                } else {
                    throw new Error('é‚®ä»¶å¤„ç†å™¨æœªåˆå§‹åŒ–');
                }
                
            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                showStatus('error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
                
                // å³ä½¿å¤±è´¥ä¹Ÿæµ‹è¯•æ‰€æœ‰æ–¹æ³•
                await testEmailMethods(formData);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘é€æµ‹è¯•é‚®ä»¶';
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æµ‹è¯•é¡µé¢...');
            
            const supabaseOk = initSupabase();
            if (supabaseOk) {
                await initEmailHandler();
            }
            
            console.log('âœ… æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>